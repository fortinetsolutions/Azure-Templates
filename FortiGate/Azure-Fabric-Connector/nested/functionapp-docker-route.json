{  
    "$schema":"http://schema.management.azure.com/schemas/2014-04-01-preview/deploymentTemplate.json#",
    "contentVersion":"1.0.0.0",
    "parameters":{  
       "AzureFunction":{  
          "type":"object"
       },
       "workloadsSettings":{  
          "type":"object"
       },
       "wlNetworkSettings":{  
          "type":"object"
       }
    },
    "variables":{},
    "resources":[  
       {  
          "type":"Microsoft.Storage/storageAccounts",
          "apiVersion":"[parameters('AzureFunction').storageAccountsApiVersion]",
          "name":"[parameters('AzureFunction').storageName]",
          "location":"[resourceGroup().location]",
          "kind":"[parameters('AzureFunction').storageAccountKind]",
          "sku":{  
             "name":"[parameters('AzureFunction').storageAccountType]"
          }
       },
       {  
          "apiVersion":"2015-05-01",
          "name":"[parameters('AzureFunction').appInsightsName]",
          "type":"Microsoft.Insights/components",
          "kind":"[parameters('AzureFunction').appInsightskind]",
          "location":"[resourceGroup().location]",
          "properties":{  
             "Application_Type":"[parameters('AzureFunction').applicationType]",
             "ApplicationId":"[parameters('AzureFunction').functionAppName]"
          }
       },
       {  
          "type":"Microsoft.Web/serverfarms",
          "apiVersion":"[parameters('AzureFunction').WebHostingApiVersion]",
          "name":"[parameters('AzureFunction').appServicePlanName]",
          "location":"[resourceGroup().location]",
          "sku":{  
             "Tier":"[parameters('AzureFunction').appServicePlanSku]",
             "Name":"[parameters('AzureFunction').appServicePlanSkuCode]"
          },
          "kind":"[parameters('AzureFunction').WebHostingkind]",
          "properties":{  
             "name":"[parameters('AzureFunction').appServicePlanName]",
             "workerSize":"[parameters('AzureFunction').workerSize]",
             "workerSizeId":"[parameters('AzureFunction').workerSizeId]",
             "numberOfWorkers":"[parameters('AzureFunction').numberOfWorkers]",
             "reserved":"[parameters('AzureFunction').reserved]",
             "hostingEnvironment":"[parameters('AzureFunction').hostingEnvironment]"
          }
       },
       {  
          "apiVersion":"[parameters('AzureFunction').WebSitesApiVersion]",
          "type":"Microsoft.Web/sites",
          "name":"[parameters('AzureFunction').functionAppName]",
          "location":"[resourceGroup().location]",
          "kind":"[parameters('AzureFunction').WebSiteskind]",
          "dependsOn":[  
             "[resourceId('Microsoft.Web/serverfarms', parameters('AzureFunction').appServicePlanName)]",
             "[resourceId('Microsoft.Storage/storageAccounts', parameters('AzureFunction').storageName)]"
          ],
          "properties":{  
             "serverFarmId":"[resourceId('Microsoft.Web/serverfarms', parameters('AzureFunction').appServicePlanName)]",
             "siteConfig":{  
                "appSettings":[  
                   {  
                      "name":"AzureWebJobsStorage",
                      "value":"[concat('DefaultEndpointsProtocol=https;AccountName=', parameters('AzureFunction').storageName, ';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('AzureFunction').storageName), providers('Microsoft.Storage', 'storageAccounts').apiVersions[0]).keys[0].value)]"
                   },
                   {  
                      "name":"FUNCTIONS_WORKER_RUNTIME",
                      "value":"[parameters('AzureFunction').functionWorkerRuntime]"
                   },
                   {  
                      "name":"WEBSITE_NODE_DEFAULT_VERSION",
                      "value":"[parameters('AzureFunction').webSiteNodeDefaultVersion]"
                   },
                   {  
                      "name":"FUNCTIONS_EXTENSION_VERSION",
                      "value":"[parameters('AzureFunction').functionExtensionVersion]"
                   },
                   {  
                      "name":"DOCKER_REGISTRY_SERVER_URL",
                      "value":"[parameters('AzureFunction').dockerRegistryURL]"
                   },
                   {  
                      "name":"WEBSITES_ENABLE_APP_SERVICE_STORAGE",
                      "value":"[parameters('AzureFunction').appServiceStroage]"
                   },
                   {  
                      "name":"VNet",
                      "value":"[parameters('wlNetworkSettings').virtualNetworkName]"
                   },
                   {  
                      "name":"Subnet1",
                      "value":"[parameters('wlNetworkSettings').subnetName1]"
                   },
                   {  
                      "name":"Subnet2",
                      "value":"[parameters('wlNetworkSettings').subnetName2]"
                   },
                   {  
                      "name":"Subnet1addressPrefix",
                      "value":"[parameters('wlNetworkSettings').subnetPrefix1]"
                   },
                   {  
                      "name":"Subnet2addressPrefix",
                      "value":"[parameters('wlNetworkSettings').subnetPrefix2]"
                   },
                   {  
                      "name":"RouteName",
                      "value":"[parameters('workloadsSettings').routeTableName]"
                   },
                   {  
                      "name":"RGName",
                      "value":"[resourceGroup().name]"
                   },
                   {  
                      "name":"AppID",
                      "value":"[parameters('workloadsSettings').clientID]"
                   },
                   {  
                      "name":"AppPassword",
                      "value":"[parameters('workloadsSettings').ClientSecret]"
                   },
                   {  
                      "name":"TenantID",
                      "value":"[parameters('workloadsSettings').tenantID]"
                   },
                   {  
                      "name":"SubscriptionID",
                      "value":"[parameters('workloadsSettings').subscriptionID]"
                   },
                   {  
                      "name":"APPINSIGHTS_INSTRUMENTATIONKEY",
                      "value":"[reference(resourceId('microsoft.insights/components/', parameters('AzureFunction').appInsightsName), parameters('AzureFunction').appInsightsApiVersion).InstrumentationKey]"
                   }
                ],
                "linuxFxVersion":"[parameters('AzureFunction').linuxFxVersion]"
             }
          }
       }
    ]
 }
